"use strict";var logGA=(...e)=>{};class SCREENPARSER{constructor(e,t,r){this.config=t,this.lib=e,1==r&&(logGA=(...e)=>{console.log("[GA] [SCREEN_PARSER]",...e)})}parse(e,t=(()=>{})){if(e.screen){var r=this.config.responseOutputURI,s=this.lib.path.resolve(__dirname,"..",r);if(!e.screen.originalContent)return;var o=e.screen.originalContent.toString("utf8");o=(o=(e=>e.replace(/document\.body,"display","none"/gim,(e=>'document.body,"display","block"')))(o)).replace("html",'html style="zoom:'+this.config.responseOutputZoom+'"');var n="/modules/MMM-GoogleAssistant/"+this.config.responseOutputCSS+"?seed="+Date.now();o=o.replace(/<style>html,body[^<]+<\/style>/gim,`<link rel="stylesheet" href="${n}">`);var l=this.lib.HTMLParser.parse(e.screen.originalContent),i=l.querySelector(".popout-content");e.screen.text=i?i.structuredText:null,e.text=i&&i.querySelector(".show_text_content")?i.querySelector(".show_text_content").structuredText:null,e.screen=this.parseScreenLink(e.screen),e.screen.photos=[];var c=l.querySelectorAll(".photo_tv_image");if(c)for(var a=0;a<c.length;a++)e.screen.photos.push(c[a].attributes["data-image-url"]);this.lib.fs.writeFile(s,o,(o=>{o?(console.error("[GA] [SCREEN_PARSER] SCREENOUTPUT_CREATION_ERROR",o),t(o)):(e.screen.path=s,e.screen.uri=r,logGA("SCREEN_OUTPUT_CREATED"),t(e))}))}}parseScreenLink(e){var t=this.lib["html-entities"].decode,r=e.originalContent;e.links=[];for(var s=[/data-url=\"([^\"]+)\"/gim,/ (http[s]?\:\/\/[^ \)]+)[ ]?\)/gim,/\: (http[s]?\:\/\/[^ <]+)/gim],o=null,n=[],l=0;l<s.length;l++)for(var i=s[l];null!==(o=i.exec(r));)n.push(t(o[1]));return e.links=n,logGA("[LINKS] Found:",e.links.length),e}}module.exports=SCREENPARSER;