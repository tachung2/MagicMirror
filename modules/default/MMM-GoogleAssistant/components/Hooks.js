class Hooks{constructor(){this.plugins={onReady:[],onNotificationReceived:[],onActivate:[],onStatus:[]},this.commands={},this.transcriptionHooks={},this.responseHooks={},console.log("[GA] Hooks Ready")}findAllHooks(o,e){var n=[];return n=(n=n.concat(this.findTranscriptionHook(e))).concat(this.findResponseHook(e)),this.findNativeAction(o,e),n}findResponseHook(o){var e=[];if(o.screen){var n=[];for(var s in n.links=o.screen.links?o.screen.links:[],n.text=o.screen.text?[].push(o.screen.text):[],n.photos=o.screen.photos?o.screen.photos:[],this.responseHooks)if(this.responseHooks.hasOwnProperty(s)){var i=this.responseHooks[s];if(i.where&&i.pattern&&i.command){var t=new RegExp(i.pattern,"ig").exec(n[i.where]);t&&(e.push({from:s,params:t,command:i.command}),logGA("ResponseHook matched:",s))}}}return e}iDontCare(o){return!!new RegExp("chatgpt|openai","ig").exec(o)}findTranscriptionHook(o){var e=[],n=o.transcription?o.transcription.transcription:"";for(var s in this.transcriptionHooks)if(this.transcriptionHooks.hasOwnProperty(s)){var i=this.transcriptionHooks[s];if(i.pattern&&i.command){var t=new RegExp(i.pattern,"ig").exec(n);if(t){if(this.iDontCare(t)){logGA(`TranscriptionHook:${s} has invalid expression`);continue}e.push({from:s,params:t,command:i.command}),logGA("TranscriptionHook matched:",s)}}else logGA(`TranscriptionHook:${s} has invalid format`)}return e}doCommand(o,e,n,s){if(this.commands.hasOwnProperty(e)){var i=this.commands[e];i.displayResponse&&(o.forceResponse=!0);var t="object"==typeof n?Object.assign({},n):n;if(i.hasOwnProperty("notificationExec")){var a=i.notificationExec;if(a.notification){var r="function"==typeof a.notification?a.notification(t,s):a.notification,c=a.payload?"function"==typeof a.payload?a.payload(t,s):a.payload:null,p="object"==typeof c?Object.assign({},c):c;this.iDontCare(r)?logGA(`Command ${e} has invalid notification`):(logGA(`Command ${e} is executed (notificationExec).`),o.sendNotification(r,p))}}if(i.hasOwnProperty("shellExec")){var l=i.shellExec;if(l.exec){var m="function"==typeof l.exec?l.exec(t,s):l.exec,h=l.options?"function"==typeof l.options?l.options(t,s):l.options:null,d="function"==typeof h?h(t,key):h;m&&(logGA(`Command ${e} is executed (shellExec).`),o.sendSocketNotification("SHELLEXEC",{command:m,options:d}))}}if(i.hasOwnProperty("moduleExec")){var f=i.moduleExec,u="function"==typeof f.module?f.module(t,s):f.module,g=Array.isArray(u)?u:new Array(u);"function"==typeof f.exec&&MM.getModules().enumerate((o=>{(0==g.length||g.indexOf(o.name)>=0)&&(logGA(`Command ${e} is executed (moduleExec) for :`,o.name),f.exec(o,t,s))}))}if(i.hasOwnProperty("soundExec")){var v=i.soundExec;v.chime&&"string"==typeof v.chime&&("open"==v.chime&&o.assistantResponse.playChime("open"),"close"==v.chime&&o.assistantResponse.playChime("close"),"opening"==v.chime&&o.assistantResponse.playChime("opening"),"closing"==v.chime&&o.assistantResponse.playChime("closing")),v.sound&&"string"==typeof v.sound&&o.assistantResponse.playChime(v.sound,!0)}}else logGA(`Command ${e} is not found.`)}parseLoadedRecipe(payload){let reviver=(key,value)=>{if("string"==typeof value&&0===value.indexOf("__FUNC__")){value=value.slice(8);let functionTemplate=`(${value})`;return eval(functionTemplate)}return value};var p=JSON.parse(payload,reviver);p.hasOwnProperty("commands")&&this.registerCommandsObject(p.commands),p.hasOwnProperty("transcriptionHooks")&&this.registerTranscriptionHooksObject(p.transcriptionHooks),p.hasOwnProperty("responseHooks")&&this.registerResponseHooksObject(p.responseHooks),p.hasOwnProperty("plugins")&&this.registerPluginsObject(p.plugins)}doPlugin(o,e,n){if(this.plugins.hasOwnProperty(e)){var s=this.plugins[e];if(Array.isArray(s)&&s.length>0)for(var i=0;i<s.length;i++){var t=s[i];this.doCommand(o,t,n,e)}}}registerPluginsObject(o){for(var e in this.plugins)if(o.hasOwnProperty(e)){var n=[];Array.isArray(o[e])?n=n.concat(o[e]):n.push(o[e].toString());for(var s=0;s<n.length;s++)this.registerPlugin(e,n[s])}}registerPlugin(o,e){this.plugins.hasOwnProperty(o)&&(Array.isArray(e)&&this.plugins[o].concat(e),this.plugins[o].push(e))}registerCommandsObject(o){this.commands=Object.assign({},this.commands,o)}registerTranscriptionHooksObject(o){this.transcriptionHooks=Object.assign({},this.transcriptionHooks,o)}registerResponseHooksObject(o){this.responseHooks=Object.assign({},this.responseHooks,o)}findNativeAction(o,e){var n=e.action?e.action:null;n&&n.inputs&&n.inputs.forEach((e=>{"action.devices.EXECUTE"==e.intent&&e.payload.commands.forEach((e=>{e.execution.forEach((e=>{logGA("Native Action: "+e.command,e.params),"action.devices.commands.SetVolume"==e.command&&(logGA("Volume Control:",e.params.volumeLevel),o.sendNotification("EXT_VOLUME-SPEAKER_SET",e.params.volumeLevel))}))}))}))}}