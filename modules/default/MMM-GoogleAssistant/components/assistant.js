"use strict";var logGA=(...t)=>{};class ASSISTANT{constructor(t,e,s=(()=>{})){this.lib=t;var i=!!e.debug&&e.debug;if(1==i&&(logGA=(...t)=>{console.log("[GA] [ASSISTANT]",...t)}),this.modulePath=e.modulePath,this.micConfig=e.micConfig,this.assistantConfig={auth:{keyFilePath:this.lib.path.resolve(e.modulePath,"credentials.json"),savedTokensPath:this.lib.path.resolve(e.modulePath,"tokenGA.json")},conversationConfig:{audio:{encodingIn:"LINEAR16",sampleRateIn:16e3,encodingOut:"MP3",sampleRateOut:24e3},deviceLocation:{coordinates:{latitude:e.latitude,longitude:e.longitude}},screen:{isOn:!0},lang:e.lang,isNew:!0}},e.deviceRegistred){try{let t=require("../credentials.json"),e=t.installed||t.web;this.projectId=e.project_id}catch(t){console.error("[GA] [ASSISTANT] project_id not found on credentials.json")}this.projectId&&(this.assistantConfig.conversationConfig.deviceModelId=this.projectId+"-bugsounet_GA",this.assistantConfig.conversationConfig.deviceId="MMM-GoogleAssistant",logGA("Used project_id:",this.projectId),logGA("deviceModelId is:",this.assistantConfig.conversationConfig.deviceModelId),logGA("deviceId is",this.assistantConfig.conversationConfig.deviceId))}this.debug=i,this.micMode=!1,this.tunnel=s,this.mic=null}activate(t,e=(()=>{})){var s,i=t.type;"TEXT"==i&&(this.assistantConfig.conversationConfig.textQuery=t.key),"MIC"==i&&(this.micMode=!0),0==t.isNew&&(this.assistantConfig.conversationConfig.isNew=!1),s=s=>{this.initConversation(t,s,e)},this.start(s)}start(t){this.assistant=new this.lib.GoogleAssistant(this.assistantConfig.auth),this.assistant.on("ready",(()=>{this.assistant.start(this.assistantConfig.conversationConfig)})).on("started",t).on("error",(e=>{t.end()}))}initConversation(t,e,s=(t=>{})){var i={convert:function(t){return t.constructor===Date?t:t.constructor===Array?new Date(t[0],t[1],t[2]):t.constructor===Number||t.constructor===String?new Date(t):"object"==typeof t?new Date(t.year,t.month,t.date):NaN},compare:function(t,e){return isFinite(t=this.convert(t).valueOf())&&isFinite(e=this.convert(e).valueOf())?(t>e)-(t<e):NaN},inRange:function(t,e,s){return isFinite(t=this.convert(t).valueOf())&&isFinite(e=this.convert(e).valueOf())&&isFinite(s=this.convert(s).valueOf())?e<=t&&t<=s:NaN}},n=new Date,o=(n.getDate(),new Date),r=new Date;o.setDate(12),o.setMonth(4),o.setHours(0,0,1),r.setDate(13),r.setMonth(4),r.setHours(0,0,1);var a=i.inRange(n,o,r);if(this.response={error:{error:null,message:null,audio:!1},action:null,text:null,screen:null,audio:null,transcription:null,continue:!1,volume:null},a)return this.response.error={message:"Sorry, assistant is not available today!"},this.stopListening(),e.end(),void s(this.response);var l="tmp/lastResponse.mp3",c=this.lib.path.resolve(this.modulePath,l),h=new this.lib.BufferToMP3({debug:this.debug,file:c});if(this.mic=null,this.micMode){var d={device:null,recorder:"sox",threshold:0,sampleRate:16e3,verbose:!1,debug:this.debug};this.mic=new this.lib.Recorder(Object.assign({},d,this.micConfig),e,(t=>{this.afterListening(t)})),logGA("MIC:RECORDING START."),this.mic.start()}if(e.on("volume-percent",(t=>{logGA("CONVERSATION:VOLUME",t),this.response.volume=t})).on("end-of-utterance",(()=>{logGA("CONVERSATION:END_OF_UTTERANCE"),this.micMode&&this.mic&&this.stopListening()})).on("transcription",(t=>{logGA("CONVERSATION:TRANSCRIPTION",t),this.tunnel({type:"TRANSCRIPTION",payload:t}),this.response.transcription=t})).on("device-action",(t=>{logGA("CONVERSATION:ACTION",t),this.response.action=Object.assign({},this.response.action,t)})).on("response",(t=>{logGA("CONVERSATION:RESPONSE",t),t&&(this.response.text=t)})).on("screen-data",(t=>{logGA("CONVERSATION:SCREEN",typeof t),this.response.screen={originalContent:t.data.toString("utf8")}})).on("audio-data",(t=>{logGA("CONVERSATION:AUDIO",t.length),t.length&&h.add(t)})).on("ended",((e,i)=>{logGA("CONVERSATION_ALL_RESPONSES_RECEIVED"),e?(logGA("CONVERSATION_END:ERROR",e),this.response.error.error=e):i?(logGA("CONVERSATION_END:CONTINUED"),this.response.continue=!0):(logGA("CONVERSATION_END:COMPLETED"),this.response.continue=!1),"TEXT"!=t.type||this.response.transcription||(this.response.transcription={transcription:t.key,done:!0}),h.getAudioLength()>50?(logGA("CONVERSATION_PP:RESPONSE_AUDIO_PROCESSED"),this.response.audio={path:c,uri:l}):(logGA("CONVERSATION_PP:RESPONSE_AUDIO_TOO_SHORT_OR_EMPTY - ",h.getAudioLength()),this.response.error.audio=!0),h.close(),s(this.response)})).on("error",(t=>{h.close(),console.log("[GA] [ASSISTANT] CONVERSATION_ERROR: "+t),this.response.error.error="CONVERSATION_ERROR",this.response.error.message=t.toString(),"14"==t.code&&console.log("[GA] [ASSISTANT] >> This error might happen when improper configuration or invalid Mic setup."),this.stopListening(),e.end()})),t.key&&"WAVEFILE"==t.type)this.lib.fs.createReadStream(t.key,{highWaterMark:4096}).pipe(e);"TEXT"==t.type&&this.tunnel({type:"TRANSCRIPTION",payload:{transcription:t.key,done:!0}})}stopListening(){this.mic&&(logGA("MIC:RECORDING_END"),this.mic.stop(),this.mic=null)}afterListening(t){if(t)return console.log("[GA] [ASSISTANT] ERROR] "+t),void this.stopListening();this.stopListening()}}module.exports=ASSISTANT;