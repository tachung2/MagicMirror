var log=(...e)=>{};function initialize(e){e.config.debug&&(log=(...e)=>{console.log("[GATEWAY]",...e)}),log("EXT plugins in database:",e.Gateway.EXT.length),e.config.username||e.config.password?(e.config.username!=e.Gateway.user.username&&e.config.password!=e.Gateway.user.password||(console.warn("[GATEWAY] WARN: You are using default username or default password"),console.warn("[GATEWAY] WARN: Don't forget to change it!")),e.Gateway.user.username=e.config.username,e.Gateway.user.password=e.config.password):(console.error("[GATEWAY] Your have not defined user/password in config!"),console.error("[GATEWAY] Using default credentials")),passportConfig(e),e.Gateway.app=e.lib.express(),e.Gateway.server=e.lib.http.createServer(e.Gateway.app),e.Gateway.EXTConfigured=e.lib.GWTools.searchConfigured(e.Gateway.MMConfig,e.Gateway.EXT),e.Gateway.EXTInstalled=e.lib.GWTools.searchInstalled(e),log("Find",e.Gateway.EXTInstalled.length,"installed plugins in MagicMirror"),log("Find",e.Gateway.EXTConfigured.length,"configured plugins in config file"),e.Gateway.GACheck.version&&e.lib.semver.gte(e.Gateway.GACheck.version,"5.1.0")?(e.Gateway.GACheck.find=!0,log("Find MMM-GoogleAssistant v"+e.Gateway.GACheck.version)):console.warn("[GATEWAY] MMM-GoogleAssistant Not Found!"),Object.keys(e.Gateway.GAConfig).length>0?(log("Find MMM-GoogleAssistant configured in MagicMirror"),e.Gateway.GACheck.configured=!0):log("MMM-GoogleAssistant is not configured!"),log("webviewTag Configured:",e.Gateway.webviewTag),log("Language set",e.Gateway.language),createGW(e)}function createGW(e){e.config.debug&&(log=(...e)=>{console.log("[GATEWAY]",...e)});var t=e.path,s=e.lib.bodyParser.urlencoded({extended:!0});log("Create Gateway needed routes..."),e.Gateway.app.use(e.lib.session({secret:"some-secret",saveUninitialized:!1,resave:!0})),e.Gateway.app.use(e.lib.bodyParser.json()),e.Gateway.app.use(e.lib.bodyParser.urlencoded({extended:!0})),e.Gateway.app.use(e.lib.passport.initialize()),e.Gateway.app.use(e.lib.passport.session());var a={dotfiles:"ignore",etag:!1,extensions:["css","js"],index:!1,maxAge:"1d",redirect:!1,setHeaders:function(e,t,s){e.set("x-timestamp",Date.now())}},o=function(e,t){t.redirect("/")},i=new e.lib.Socket.Server(e.Gateway.server);e.Gateway.app.use(logRequest).use(e.lib.cors({origin:"*"})).use("/EXT_Login.js",e.lib.express.static(t+"/tools/EXT_Login.js")).use("/EXT_Home.js",e.lib.express.static(t+"/tools/EXT_Home.js")).use("/EXT_Plugins.js",e.lib.express.static(t+"/tools/EXT_Plugins.js")).use("/EXT_Terminal.js",e.lib.express.static(t+"/tools/EXT_Terminal.js")).use("/EXT_MMConfig.js",e.lib.express.static(t+"/tools/EXT_MMConfig.js")).use("/EXT_Tools.js",e.lib.express.static(t+"/tools/EXT_Tools.js")).use("/EXT_System.js",e.lib.express.static(t+"/tools/EXT_System.js")).use("/EXT_Setting.js",e.lib.express.static(t+"/tools/EXT_Setting.js")).use("/EXT_Restart.js",e.lib.express.static(t+"/tools/EXT_Restart.js")).use("/EXT_Die.js",e.lib.express.static(t+"/tools/EXT_Die.js")).use("/EXT_Fetch.js",e.lib.express.static(t+"/tools/EXT_Fetch.js")).use("/assets",e.lib.express.static(t+"/website/assets",a)).use("/jsoneditor",e.lib.express.static(t+"/node_modules/jsoneditor")).use("/xterm",e.lib.express.static(t+"/node_modules/xterm")).use("/xterm-addon-fit",e.lib.express.static(t+"/node_modules/xterm-addon-fit")).get("/",((e,s)=>{e.user?s.sendFile(t+"/website/Gateway/index.html"):s.redirect("/login")})).get("/version",((t,s)=>{var a={v:require("../package.json").version,rev:require("../package.json").rev,lang:e.Gateway.language,last:0,imperial:"imperial"==e.Gateway.MMConfig.units,needUpdate:!1};e.lib.fetch("https://raw.githubusercontent.com/bugsounet/Gateway/master/package.json").then((e=>e.json())).then((t=>{a.last=t.version,e.lib.semver.gt(a.last,a.v)&&(a.needUpdate=!0),s.send(a)})).catch((e=>{console.error("[GATEWAY] Error on fetch last version number"),s.send(a)}))})).get("/systemInformation",(async(s,a)=>{s.user?(e.Gateway.systemInformation.result=await e.Gateway.systemInformation.lib.Get(),a.send(e.Gateway.systemInformation.result)):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/translation",((t,s)=>{s.send(e.Gateway.translation)})).get("/homeText",((t,s)=>{s.send({text:e.Gateway.homeText})})).get("/EXT",((e,s)=>{e.user?s.sendFile(t+"/website/Gateway/EXT.html"):s.redirect("/login")})).get("/login",((e,s)=>{e.user&&s.redirect("/"),s.sendFile(t+"/website/Gateway/login.html")})).post("/auth",((t,s,a)=>{var o=t.headers["x-forwarded-for"]||t.connection.remoteAddress;e.lib.passport.authenticate("login",((e,i,n)=>e?(console.log("[GATEWAY] ["+o+"] Error",e),a(e)):i?void t.logIn(i,(e=>e?(console.log("[GATEWAY] ["+o+"] Login error:",e),s.send({err:e})):(console.log("[GATEWAY] ["+o+"] Welcome "+i.username+", happy to serve you!"),s.send({login:!0})))):(console.log("[GATEWAY] ["+o+"] Bad Login",n),s.send({err:n}))))(t,s,a)})).get("/logout",((e,t)=>{e.logout((e=>{if(e)return console.error("[GATEWAY] Logout:",e);t.redirect("/")}))})).get("/AllEXT",((s,a)=>{s.user?a.send(e.Gateway.EXT):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/DescriptionEXT",((s,a)=>{s.user?a.send(e.Gateway.EXTDescription):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/InstalledEXT",((s,a)=>{s.user?a.send(e.Gateway.EXTInstalled):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/ConfiguredEXT",((s,a)=>{s.user?a.send(e.Gateway.EXTConfigured):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetMMConfig",((s,a)=>{s.user?a.send(e.Gateway.MMConfig):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Terminal",((s,a)=>{if(s.user){var o=s.headers["x-forwarded-for"]||s.connection.remoteAddress;a.sendFile(t+"/website/Gateway/terminal.html"),i.once("connection",(async t=>{log("["+o+"] Connected to Terminal Logs:",s.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from Terminal Logs:",s.user.username,"["+e+"]")}));var a=await e.lib.GWTools.readAllMMLogs(e.Gateway.HyperWatch.logs());i.emit("terminal.logs",a),e.Gateway.HyperWatch.stream().on("stdData",(e=>{"string"==typeof e&&i.to(t.id).emit("terminal.logs",e.replace(/\r?\n/g,"\r\n"))}))}))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/ptyProcess",((s,a)=>{if(s.user){var o=s.headers["x-forwarded-for"]||s.connection.remoteAddress;a.sendFile(t+"/website/Gateway/pty.html"),i.once("connection",(t=>{log("["+o+"] Connected to Terminal:",s.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from Terminal:",s.user.username,"["+e+"]")}));var a=e.lib.pty.spawn("bash",[],{name:"xterm-color",cols:80,rows:24,cmd:process.env.HOME,env:process.env});a.on("data",(e=>{i.to(t.id).emit("terminal.incData",e)})),t.on("terminal.toTerm",(e=>{a.write(e)})),t.on("terminal.size",(e=>{a.resize(e.cols,e.rows)}))}))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/install",((s,a)=>{if(s.user){var o=s.headers["x-forwarded-for"]||s.connection.remoteAddress;s.query.ext&&-1==e.Gateway.EXTInstalled.indexOf(s.query.ext)&&e.Gateway.EXT.indexOf(s.query.ext)>-1?(a.sendFile(t+"/website/Gateway/install.html"),i.once("connection",(async t=>{log("["+o+"] Connected to installer Terminal Logs:",s.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from installer Terminal Logs:",s.user.username,"["+e+"]")})),e.Gateway.HyperWatch.stream().on("stdData",(e=>{"string"==typeof e&&i.to(t.id).emit("terminal.installer",e.replace(/\r?\n/g,"\r\n"))}))}))):a.status(404).sendFile(t+"/website/Gateway/404.html")}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTInstall",((s,a)=>{if(s.user){var o=s.headers["x-forwarded-for"]||s.connection.remoteAddress;if(s.query.EXT&&-1==e.Gateway.EXTInstalled.indexOf(s.query.EXT)&&e.Gateway.EXT.indexOf(s.query.EXT)>-1){console.log("[GATEWAY]["+o+"] Request installation:",s.query.EXT);var i={error:!1},n=e.lib.path.normalize(t+"/../"),r="cd "+n+" && git clone https://github.com/bugsounet/"+s.query.EXT+" && cd "+s.query.EXT+" && npm install",l=e.lib.childProcess.exec(r,{cwd:n},((t,o,n)=>{t?(i.error=!0,console.error(`[GATEWAY][FATAL] exec error: ${t}`)):(e.Gateway.EXTInstalled=e.lib.GWTools.searchInstalled(e),console.log("[GATEWAY][DONE]",s.query.EXT)),a.json(i)}));l.stdout.pipe(process.stdout),l.stderr.pipe(process.stdout)}else a.status(404).sendFile(t+"/website/Gateway/404.html")}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/delete",((s,a)=>{if(s.user){var o=s.headers["x-forwarded-for"]||s.connection.remoteAddress;s.query.ext&&e.Gateway.EXTInstalled.indexOf(s.query.ext)>-1&&e.Gateway.EXT.indexOf(s.query.ext)>-1?(a.sendFile(t+"/website/Gateway/delete.html"),i.once("connection",(async t=>{log("["+o+"] Connected to uninstaller Terminal Logs:",s.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from uninstaller Terminal Logs:",s.user.username,"["+e+"]")})),e.Gateway.HyperWatch.stream().on("stdData",(e=>{"string"==typeof e&&i.to(t.id).emit("terminal.delete",e.replace(/\r?\n/g,"\r\n"))}))}))):a.status(404).sendFile(t+"/website/Gateway/404.html")}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTDelete",((s,a)=>{if(s.user){var o=s.headers["x-forwarded-for"]||s.connection.remoteAddress;if(s.query.EXT&&e.Gateway.EXTInstalled.indexOf(s.query.EXT)>-1&&e.Gateway.EXT.indexOf(s.query.EXT)>-1){console.log("[GATEWAY]["+o+"] Request delete:",s.query.EXT);var i={error:!1},n=e.lib.path.normalize(t+"/../"),r="cd "+n+" && rm -rfv "+s.query.EXT,l=e.lib.childProcess.exec(r,{cwd:n},((t,o,n)=>{t?(i.error=!0,console.error(`[GATEWAY][FATAL] exec error: ${t}`)):(e.Gateway.EXTInstalled=e.lib.GWTools.searchInstalled(e),console.log("[GATEWAY][DONE]",s.query.EXT)),a.json(i)}));l.stdout.pipe(process.stdout),l.stderr.pipe(process.stdout)}else a.status(404).sendFile(t+"/website/Gateway/404.html")}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/MMConfig",((e,s)=>{e.user?s.sendFile(t+"/website/Gateway/mmconfig.html"):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTCreateConfig",((s,a)=>{s.user?s.query.ext&&e.Gateway.EXTInstalled.indexOf(s.query.ext)>-1&&e.Gateway.EXT.indexOf(s.query.ext)>-1&&-1==e.Gateway.EXTConfigured.indexOf(s.query.ext)?a.sendFile(t+"/website/Gateway/EXTCreateConfig.html"):a.status(404).sendFile(t+"/website/Gateway/404.html"):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTModifyConfig",((s,a)=>{s.user?s.query.ext&&e.Gateway.EXTInstalled.indexOf(s.query.ext)>-1&&e.Gateway.EXT.indexOf(s.query.ext)>-1&&e.Gateway.EXTConfigured.indexOf(s.query.ext)>-1?a.sendFile(t+"/website/Gateway/EXTModifyConfig.html"):a.status(404).sendFile(t+"/website/Gateway/404.html"):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTDeleteConfig",((s,a)=>{s.user?s.query.ext&&-1==e.Gateway.EXTInstalled.indexOf(s.query.ext)&&e.Gateway.EXT.indexOf(s.query.ext)>-1&&e.Gateway.EXTConfigured.indexOf(s.query.ext)>-1?a.sendFile(t+"/website/Gateway/EXTDeleteConfig.html"):a.status(404).sendFile(t+"/website/Gateway/404.html"):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTGetCurrentConfig",((s,a)=>{if(s.user){if(!s.query.ext)return a.status(404).sendFile(t+"/website/Gateway/404.html");var o=e.Gateway.MMConfig.modules.map((e=>e.module)).indexOf(s.query.ext);if(o>-1){let t=e.Gateway.MMConfig.modules[o];return a.send(t)}a.status(404).sendFile(t+"/website/Gateway/404.html")}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTGetDefaultConfig",((e,s)=>{if(e.user){if(!e.query.ext)return s.status(404).sendFile(t+"/website/Gateway/404.html");let a=require("../config/"+e.query.ext+"/config.js");s.send(a.default)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTGetDefaultTemplate",((s,a)=>{if(s.user){if(!s.query.ext)return a.status(404).sendFile(t+"/website/Gateway/404.html");let o=require("../config/"+s.query.ext+"/config.js");o.schema=e.lib.GWTools.makeSchemaTranslate(o.schema,e.Gateway.schemaTranslatation),a.send(o.schema)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTSaveConfig",((e,s)=>{if(e.user){if(!e.query.config)return s.status(404).sendFile(t+"/website/Gateway/404.html");let a=e.query.config;s.send(a)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/writeEXT",(async(s,a)=>{if(s.user){console.log("[Gateway] Receiving EXT data ...");let t=JSON.parse(s.body.data);var o=await e.lib.GWTools.configAddOrModify(t,e.Gateway.MMConfig),i=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write config result:",i),a.send(i),i.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),e.Gateway.EXTConfigured=e.lib.GWTools.searchConfigured(e.Gateway.MMConfig,e.Gateway.EXT),console.log("[GATEWAY] Reload config"))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/deleteEXT",(async(s,a)=>{if(s.user){console.log("[Gateway] Receiving EXT data ...",s.body),console.log("user",s.user);let t=s.body.data;var o=await e.lib.GWTools.configDelete(t,e.Gateway.MMConfig),i=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write config result:",i),a.send(i),i.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),e.Gateway.EXTConfigured=e.lib.GWTools.searchConfigured(e.Gateway.MMConfig,e.Gateway.EXT),console.log("[GATEWAY] Reload config"))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Tools",((e,s)=>{e.user?s.sendFile(t+"/website/Gateway/tools.html"):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/System",((s,a)=>{s.user?(a.sendFile(t+"/website/Gateway/system.html"),new e.lib.speedtest(e.lib,i,s,e.Gateway,e.config.debug).init()):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Setting",((e,s)=>{e.user?s.sendFile(t+"/website/Gateway/setting.html"):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/getSetting",((s,a)=>{s.user?a.send(e.config):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Restart",((s,a)=>{s.user?(a.sendFile(t+"/website/Gateway/restarting.html"),setTimeout((()=>e.lib.GWTools.restartMM(e)),1e3)):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Die",((s,a)=>{s.user?(a.sendFile(t+"/website/Gateway/die.html"),setTimeout((()=>e.lib.GWTools.doClose(e)),3e3)):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/SystemRestart",((s,a)=>{s.user?(a.sendFile(t+"/website/Gateway/restarting.html"),setTimeout((()=>e.lib.GWTools.SystemRestart(e)),1e3)):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/SystemDie",((s,a)=>{s.user?(a.sendFile(t+"/website/Gateway/die.html"),setTimeout((()=>e.lib.GWTools.SystemDie(e)),3e3)):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EditMMConfig",((e,s)=>{e.user?s.sendFile(t+"/website/Gateway/EditMMConfig.html"):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetBackupName",(async(s,a)=>{if(s.user){var o=await e.lib.GWTools.loadBackupNames(e);a.send(o)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetBackupFile",(async(s,a)=>{if(s.user){let t=s.query.config;var o=await e.lib.GWTools.loadBackupFile(e,t);a.send(o)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetRadioStations",((s,a)=>{if(s.user){if(!e.Gateway.radio)return a.status(404).sendFile(t+"/website/Gateway/404.html");var o=Object.keys(e.Gateway.radio);a.send(o)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/loadBackup",(async(s,a)=>{if(s.user){console.log("[Gateway] Receiving backup data ...");let t=s.body.data;var o=await e.lib.GWTools.loadBackupFile(e,t),i=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write config result:",i),a.send(i),i.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/writeConfig",(async(s,a)=>{if(s.user){console.log("[Gateway] Receiving config data ...");let t=JSON.parse(s.body.data);var o=await e.lib.GWTools.saveConfig(e,t);console.log("[GATEWAY] Write config result:",o),a.send(o),o.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/saveSetting",s,(async(s,a)=>{if(s.user){console.log("[Gateway] Receiving new Setting");let t=JSON.parse(s.body.data);var o=await e.lib.GWTools.configAddOrModify(t,e.Gateway.MMConfig),i=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write Gateway config result:",i),a.send(i),i.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/getWebviewTag",((s,a)=>{s.user?a.send(e.Gateway.webviewTag):a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/setWebviewTag",(async(s,a)=>{if(!e.Gateway.webviewTag&&s.user){console.log("[Gateway] Receiving setWebviewTag demand...");let t=await e.lib.GWTools.setWebviewTag(e.Gateway.MMConfig);var o=await e.lib.GWTools.saveConfig(e,t);console.log("[GATEWAY] Write Gateway webview config result:",o),a.send(o),o.done&&(e.Gateway.webviewTag=!0,e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/getGAVersion",((s,a)=>{s.user?(e.Gateway.EXTStatus.GA_Ready&&(e.Gateway.GACheck.ready=!0),a.send(e.Gateway.GACheck)):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/getEXTStatus",((s,a)=>{s.user?a.send(e.Gateway.EXTStatus):a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/EXT-Screen",((t,s)=>{if(t.user){let a=t.body.data;if("OFF"==a)return e.sendSocketNotification("SendNoti","EXT_SCREEN-END"),s.send("ok");if("ON"==a)return e.sendSocketNotification("SendNoti","EXT_SCREEN-WAKEUP"),s.send("ok");s.send("error")}else s.send("error")})).post("/EXT-GAQuery",((t,s)=>{if(t.user){let a=t.body.data;if(!a)return s.send("error");e.sendSocketNotification("SendNoti",{noti:"GA_ACTIVATE",payload:{type:"TEXT",key:a}}),s.send("ok")}else s.send("error")})).post("/EXT-AlertQuery",((t,s)=>{if(t.user){let a=t.body.data;if(!a)return s.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_ALERT",payload:{type:"information",message:a,sender:t.user?t.user.username:"Gateway",timer:3e4,sound:"modules/Gateway/tools/message.mp3",icon:"modules/Gateway/website/assets/img/gateway.jpg"}}),s.send("ok")}else s.send("error")})).post("/EXT-VolumeSendSpeaker",((t,s)=>{if(t.user){let a=t.body.data;if(!a)return s.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_VOLUME-SPEAKER_SET",payload:a}),s.send("ok")}else s.send("error")})).post("/EXT-VolumeSendRecorder",((t,s)=>{if(t.user){let a=t.body.data;if(!a)return s.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_VOLUME-RECORDER_SET",payload:a}),s.send("ok")}else s.send("error")})).post("/EXT-SpotifyQuery",((t,s)=>{if(t.user){if(!t.body.data)return s.send("error");let o=t.body.data.query,i=t.body.data.type;if(!o||!i)return s.send("error");var a={type:i,query:o,random:!1};e.sendSocketNotification("SendNoti",{noti:"EXT_SPOTIFY-SEARCH",payload:a}),s.send("ok")}else s.send("error")})).post("/EXT-SpotifyPlay",((t,s)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-PLAY"),s.send("ok")):s.send("error")})).post("/EXT-SpotifyStop",((t,s)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-STOP"),s.send("ok")):s.send("error")})).post("/EXT-SpotifyNext",((t,s)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-NEXT"),s.send("ok")):s.send("error")})).post("/EXT-SpotifyPrevious",((t,s)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-PREVIOUS"),s.send("ok")):s.send("error")})).post("/EXT-UNUpdate",((t,s)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_UPDATENOTIFICATION-UPDATE"),s.send("ok")):s.send("error")})).post("/EXT-YouTubeQuery",((t,s)=>{if(t.user){let a=t.body.data;if(!a)return s.send("error");e.Gateway.EXTStatus["EXT-YouTube"].hello?(e.sendSocketNotification("SendNoti",{noti:"EXT_YOUTUBE-SEARCH",payload:a}),s.send("ok")):s.send("error")}else s.send("error")})).post("/EXT-FreeboxTVQuery",((t,s)=>{if(e.Gateway.freeteuse&&t.user){let a=t.body.data;if(!a)return s.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_FREEBOXTV-PLAY",payload:a}),s.send("ok")}else s.send("error")})).post("/EXT-RadioQuery",((t,s)=>{if(t.user){let o=t.body.data;if(!o)return s.send("error");try{var a=e.Gateway.radio[o].notificationExec.payload();e.sendSocketNotification("SendNoti",{noti:"EXT_RADIO-START",payload:a})}catch(e){s.send("error")}s.send("ok")}else s.send("error")})).post("/EXT-StopQuery",((t,s)=>{t.user?(e.sendSocketNotification("SendStop"),e.sendSocketNotification("SendNoti","EXT_STOP"),s.send("ok")):s.send("error")})).post("/deleteBackup",(async(s,a)=>{if(s.user){console.log("[GATEWAY] Receiving delete backup demand...");var o=await e.lib.GWTools.deleteBackup(e);console.log("[GATEWAY] Delete backup result:",o),a.send(o)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/readExternalBackup",(async(s,a)=>{if(s.user){let t=s.body.data;if(!t)return a.send({error:"error"});console.log("[GATEWAY] Receiving External backup...");var o=await e.lib.GWTools.transformExternalBackup(e,t);a.send({data:o})}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/saveExternalBackup",(async(s,a)=>{if(s.user){let n=s.body.data;if(!n)return a.send({error:"error"});console.log("[GATEWAY] Receiving External backup...");var i=await e.lib.GWTools.saveExternalConfig(e,n);i.data&&(console.log("[GATEWAY] Generate link number:",i.data),o=(s,a)=>{s.params[0]==i.data?(a.sendFile(t+"/download/"+i.data+".js"),o=function(e,t){t.redirect("/")},setTimeout((()=>{e.lib.GWTools.deleteDownload(e,i.data)}),1e4)):a.redirect("/")}),a.send(i)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/activeVersion",((s,a)=>{s.user?a.send(e.Gateway.activeVersion):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/download/*",((e,t)=>{o(e,t)})).get("/robots.txt",((e,s)=>{s.sendFile(t+"/website/Gateway/robots.txt")}))}async function startServer(e,t=(()=>{})){e.Gateway.app.get("/smarthome/*",((t,s)=>{console.warn("[GATEWAY] [SMARTHOME] Don't find:",t.url),s.status(404).sendFile(e.path+"/website/SmartHome/404.html")})),e.Gateway.app.get("/*",((t,s)=>{console.warn("[GATEWAY] Don't find:",t.url),s.status(404).sendFile(e.path+"/website/Gateway/404.html")})),e.config.listening=await e.lib.GWTools.purposeIP(e),e.Gateway.HyperWatch=e.lib.hyperwatch(e.Gateway.server.listen(8081,"0.0.0.0",(()=>{console.log("[GATEWAY] Start listening on port 8081"),console.log("[GATEWAY] Available locally at http://"+e.config.listening+":8081"),e.Gateway.initialized=!0,t(!0)})).on("error",(s=>{console.error("[GATEWAY] Can't start Gateway server!"),console.error("[GATEWAY] Error:",s.message),e.sendSocketNotification("SendNoti",{noti:"EXT_ALERT",payload:{type:"error",message:"Can't start Gateway server!",timer:1e4}}),e.Gateway.initialized=!1,t(!1)})))}function passportConfig(e){e.lib.passport.use("login",new e.lib.LocalStrategy.Strategy(((t,s,a)=>{if(t===e.Gateway.user.username&&s===e.Gateway.user.password)return a(null,e.Gateway.user);a(null,!1,{message:e.Gateway.translation.Login_Error})}))),e.lib.passport.serializeUser(((e,t)=>{t(null,e._id)})),e.lib.passport.deserializeUser(((t,s)=>{s(null,e.Gateway.user)}))}function logRequest(e,t,s){var a=e.headers["x-forwarded-for"]||e.connection.remoteAddress;log("["+a+"]["+e.method+"] "+e.url),s()}exports.initialize=initialize,exports.startServer=startServer;