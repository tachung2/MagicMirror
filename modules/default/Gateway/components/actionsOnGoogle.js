var log=(...e)=>{};function actions(e){e.config.debug&&(log=(...e)=>{console.log("[GATEWAY] [SMARTHOME] [ACTIONS]",...e)}),e.SmartHome.actions.onSync(((t,n)=>{log("[SYNC] Request:",JSON.stringify(t));let s=e.lib.SHTools.check_token(e,n);if(!s)return console.error("[GATEWAY] [SMARTHOME] [ACTIONS] [SYNC] Error: user_id not found!"),{};var a={};a.requestId=t.requestId,a.payload={agentUserId:s,devices:[]};let o=e.lib.SHTools.get_userOnly(e,s),c=e.lib.SHTools.get_device(o.devices[0],e.SmartHome.device);return a.payload.devices.push(c),log("[SYNC] Send Result:",JSON.stringify(a)),a})),e.SmartHome.actions.onExecute(((t,n)=>{if(log("[EXECUTE] Request:",JSON.stringify(t)),!e.lib.SHTools.check_token(e,n))return console.error("[SMARTHOME] [ACTIONS] [EXECUTE] Error: user_id not found!"),{};var s={payload:{}};s.payload.commands=[];let a=t.inputs,o=a[0].payload.commands[0].devices[0].id||null,c=a[0].payload.commands[0].execution[0].command||null,l=a[0].payload.commands[0].execution[0].hasOwnProperty("params")?a[0].payload.commands[0].execution[0].params:null,i=execute(e,c,l);return i.ids=[o],s.payload.commands.push(i),log("[EXECUTE] Send Result:",JSON.stringify(s)),s})),e.SmartHome.actions.onQuery(((t,n)=>{if(log("[QUERY] Request:",JSON.stringify(t)),!e.lib.SHTools.check_token(e,n))return console.error("[SMARTHOME] [ACTIONS] [QUERY] Error: user_id not found!"),{};var s={payload:{}};s.payload.devices={};let a=t.inputs[0].payload.devices[0].id||null;return log("[QUERY] device_id:",a),s.payload.devices[a]=query(e.SmartHome),log("[QUERY] Send Result:",JSON.stringify(s)),s})),e.SmartHome.actions.onDisconnect(((t,n)=>(log("[Disconnect]"),e.lib.SHTools.delete_token(e,e.lib.SHTools.get_token(n)),{})))}function query(e){let t=e.smarthome,n=e.EXT,s={online:!0};return e.init?(n["EXT-Screen"]&&(s.on=t.Screen),n["EXT-Volume"]&&(s.currentVolume=t.Volume,s.isMuted=t.VolumeIsMuted),n["EXT-FreeboxTV"]&&t.TvIsPlaying?s.currentInput="EXT-FreeboxTV":n["EXT-SpotifyCanvasLyrics"]&&t.Lyrics?s.currentInput="EXT-SpotifyCanvasLyrics":n["EXT-Pages"]&&(s.currentInput="page "+t.Page),n["EXT-Spotify"]&&(s.currentApplication=t.SpotifyIsConnected?"spotify":"home"),log("[QUERY] Result:",s),s):(s={online:!1},log("[QUERY] Result:",s),s)}function execute(e,t,n){let s=e.SmartHome.smarthome;switch(t){case"action.devices.commands.OnOff":return n.on?e.lib.callback.send(e,"screen","ON"):e.lib.callback.send(e,"screen","OFF"),{status:"SUCCESS",states:{on:n.on,online:!0}};case"action.devices.commands.volumeRelative":let t=0;return n.volumeRelativeLevel>0?(t=s.Volume+5,t>100&&(t=100),e.lib.callback.send(e,"volumeUp")):(t=s.Volume-5,t<0&&(t=0),e.lib.callback.send(e,"volumeDown")),{status:"SUCCESS",states:{online:!0,currentVolume:t,isMuted:s.VolumeIsMuted}};case"action.devices.commands.setVolume":return e.lib.callback.send(e,"volume",n.volumeLevel),{status:"SUCCESS",states:{online:!0,currentVolume:n.volumeLevel,isMuted:s.VolumeIsMuted}};case"action.devices.commands.mute":return e.lib.callback.send(e,"volume",1==n.mute?"mute":"unmute"),{status:"SUCCESS",states:{online:!0,isMuted:n.mute,currentVolume:s.Volume}};case"action.devices.commands.SetInput":log("SetInput",n);let a=n.newInput.split(" ");return"Stop"==a?(e.lib.callback.send(e,"Stop"),n.newInput="page "+s.Page):"EXT-FreeboxTV"==a?(e.lib.callback.send(e,"TVPlay"),n.newInput=a):"EXT-SpotifyCanvasLyrics"==a?(s.LyricsIsForced||s.Lyrics?s.LyricsIsForced&&e.lib.callback.send(e,"SpotifyLyricsOff"):e.lib.callback.send(e,"SpotifyLyricsOn"),s.SpotifyIsPlaying||e.lib.callback.send(e,"SpotifyPlay"),n.newInput=a):e.lib.callback.send(e,"setPage",a[1]),{status:"SUCCESS",states:{online:!0,currentInput:n.newInput}};case"action.devices.commands.NextInput":return e.lib.callback.send(e,"setNextPage"),{status:"SUCCESS",states:{online:!0}};case"action.devices.commands.PreviousInput":return e.lib.callback.send(e,"setPreviousPage"),{status:"SUCCESS",states:{online:!0}};case"action.devices.commands.Reboot":return e.lib.callback.send(e,"Reboot"),{};case"action.devices.commands.Locate":return e.lib.callback.send(e,"Locate"),{status:"SUCCESS"};case"action.devices.commands.mediaStop":return e.lib.callback.send(e,"Stop"),{};case"action.devices.commands.mediaNext":return e.lib.callback.send(e,"SpotifyNext"),{};case"action.devices.commands.mediaPrevious":return e.lib.callback.send(e,"SpotifyPrevious"),{};case"action.devices.commands.mediaPause":return s.SpotifyIsPlaying&&e.lib.callback.send(e,"SpotifyPause"),{};case"action.devices.commands.mediaResume":return s.SpotifyIsPlaying||e.lib.callback.send(e,"SpotifyPlay"),{};case"action.devices.commands.appSelect":return"spotify"==n.newApplication&&(s.SpotifyIsConnected||s.SpotifyIsPlaying||e.lib.callback.send(e,"SpotifyPlay")),{status:"SUCCESS",states:{online:!0,currentApplication:n.newApplication}};case"action.devices.commands.relativeChannel":return n.relativeChannelChange>0?e.lib.callback.send(e,"TVNext"):e.lib.callback.send(e,"TVPrevious"),{status:"SUCCESS"};default:return{status:"ERROR"}}}exports.actions=actions;