var log=(...e)=>{};function initialize(e){e.config.debug&&(log=(...e)=>{console.log("[GATEWAY] [SMARTHOME]",...e)});let t=e.lib.path.resolve(__dirname+"/../website/SmartHome"),o=e.lib.path.resolve(__dirname+"/../tokens/");e.SmartHome.actions=e.lib.actions.smarthome(),log("Create SmartHome needed routes..."),e.lib.ActionsOnGoogle.actions(e),e.Gateway.app.get("/smarthome/login/",((o,s)=>{e.SmartHome.init?s.sendFile(t+"/login.html"):s.sendFile(t+"/disabled.html")})).post("/smarthome/login/",((o,s)=>{let i=o.body,a=o.query;if(i.username&&i.password&&a.state&&a.response_type&&"code"==a.response_type&&a.client_id==e.config.CLIENT_ID){if(!e.lib.SHTools.get_user(e,i.username,i.password))return s.sendFile(t+"/login.html");e.SmartHome.last_code=e.lib.SHTools.random_string(8),e.SmartHome.last_code_user=i.username,e.SmartHome.last_code_time=(new Date).getTime()/1e3;let o={state:a.state,code:e.SmartHome.last_code,client_id:e.config.CLIENT_ID};log("[AUTH] Generate Code:",e.SmartHome.last_code),s.status(301).redirect(a.redirect_uri+e.lib.SHTools.serialize(o))}else s.status(400).sendFile(t+"/400.html")})).post("/smarthome/token/",((s,i)=>{let a=s.body;if(a.grant_type&&"authorization_code"==a.grant_type&&a.code&&a.code==e.SmartHome.last_code)if((new Date).getTime()/1e3-e.SmartHome.last_code_time>10)log("[TOKEN] Invalid code (timeout)"),i.status(403).sendFile(t+"/403.html");else{let t=e.lib.SHTools.random_string(32);e.lib.fs.writeFileSync(o+"/"+t,e.SmartHome.last_code_user,{encoding:"utf8"}),log("|TOKEN] Send Token:",t),i.json({access_token:t})}else log("[TOKEN] Invalid code"),i.status(403).sendFile(t+"/403.html")})).get("/smarthome/",((e,o)=>{o.sendFile(t+"/works.html")})).post("/smarthome/",e.SmartHome.actions).get("/smarthome/graph",((o,s)=>{e.SmartHome.homegraph&&e.lib.homegraph.queryGraph(e),s.status(404).sendFile(t+"/404.html")}))}function disable(e){e.config.debug&&(log=(...e)=>{console.log("[GATEWAY] [SMARTHOME]",...e)});let t=e.lib.path.resolve(__dirname+"/../website/SmartHome");e.Gateway.app.get("/smarthome/login/",((e,o)=>{o.sendFile(t+"/disabled.html")})).get("/smarthome/",((e,o)=>{o.sendFile(t+"/disabled.html")})).get("/robots.txt",((e,o)=>{o.sendFile(t+"/robots.txt")}))}exports.initialize=initialize,exports.disable=disable;